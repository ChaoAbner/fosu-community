# 社区一站式高性能存储方案

- 点赞
- 关注
- 优化登录模块

先介绍下Redis

## Redis

### 入门

![](http://img.fosuchao.com/20200405171331.png)

### Spring整合Redis

![](http://img.fosuchao.com/20200405171358.png)

## 点赞

### 功能

- 支持对帖子、评论点赞（不同的实体）
- 点赞、取消点赞（根据点赞状态）
- 统计点赞数量

### 点赞服务

- 帖子、评论显示点赞数量
- 帖子、评论显示点赞状态
- 用户记录获得的点赞数量

### 功能实现

**记录某个实体的点赞**

以`like:entityType:entityId`为key，用一个集合来保存点赞者的id，即（userid_1， userid_2...）

- 用于判断用户是否对某个实体进行了点赞(isMember)
- 判断某个实体的点赞数量(size)

**记录某个用户获得的点赞数**

以`like:userId`为key，用value来保存数量。

每当一个实体被点赞/取消点赞的时候，将实体对应的用户的key进行`increment(key)`, `decrement(key)`即可

## 关注

### 功能

- 用户关注了某个实体（收藏） -- TODO
- 用户关注了用户（关注/粉丝）
- 统计关注/粉丝数量

### 服务

- 对实体状态更新或者关注用户的发布行为进行推送 -- TODO
- 判断是否已关注
- 获取用户关注/粉丝数

### 功能实现

**记录某个实体的粉丝**

以`follower:entityType:entityId`为key，用一个集合来保存所有的关注者

比如（userid_1, userid_2...）

- 获取实体的粉丝数（size(key)）
- 判断某个用户是否关注该实体（isMember(userid, key)）

**记录某个用户的关注**

以`followee:entityType:entityId`为key，用一个集合来保存用户所有关注对象

比如关注的所有用户（userid1, userid2，userid3...)

比如关注/收藏的所有文章（postid1, postid2，postid3...)

### 关键

- 若A关注了B，则A是B的Follower（粉丝），B是A的关注目标（Followee）
- 关注的目标可以是用户、帖子等等、所以需要将关注的目标抽象成实体，通过实体类型来判断。

## 优化登录模块

​		如果使用数据库存储登录凭证的话，每次用户的请求都需要从数据库中进行查找对比，性能不好而且占用空间。使用缓存可以设置过期时间。验证码同理。

### 使用Redis存储验证码

- 验证码需要频繁访问和刷新，对性能要求较高。
- 验证码不需要永久保存，通常在很短的时间就失效过期
- 分布式部署时候，存在session共享的问题

**具体实现**

​		后台生成验证码后，用一个随机数作为key，在redis中保存。并且将这个key作为一个Cookie的value保存起来。登录时，直接从用户的cookie中取出这个值并且在redis中查找出来，如果为空或者不相等的情况，则验证不通过。否则验证码验证通过。

### 使用Redis存储登录凭证

- 处理每次请求时，都要查询用户的登录凭证，访问频率很高

**具体实现**

以`ticket:userId`作为键来存储凭证，每次都从redis中获取。

### 使用Redis存储用户信息

- 处理每次请求时，都要通过凭证来查询用户的信息（个人设置），访问频率很高

**具体实现**

以`user:userId`作为键来存储凭证，每次都从redis中获取。当我们要查询用户信息时，先通过redis去查找，如果找不到，就通过数据库查找，并且设置到redis中。

注意：每当用户的信息更新时（更改头像，昵称等等），需要将缓存删除，以便获取最新的用户信息。